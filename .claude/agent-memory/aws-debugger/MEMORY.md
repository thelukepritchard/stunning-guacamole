# AWS Debugger Memory — Signalr (ap-southeast-2)

## Key Resource Names

### Lambda Functions
- `signalr-prod-analytics-handler` — Analytics API (GET /analytics/performance, /analytics/bots/{botId}/performance, /analytics/leaderboard, /analytics/leaderboard/{username})
- `signalr-prod-analytics-bot-perf-recorder` — EventBridge 5-min schedule, writes bot P&L snapshots
- `signalr-prod-analytics-portfolio-perf-recorder` — EventBridge 5-min schedule, writes portfolio P&L snapshots

### DynamoDB Tables
- `signalr-prod-analytics-bot-performance` — PK: botId, SK: timestamp. GSI: sub-index (PK: sub, SK: timestamp, ALL projection)
- `signalr-prod-analytics-portfolio-performance` — PK: sub, SK: timestamp
- `signalr-prod-bots` — used by analytics for bot ownership verification; PK: sub, SK: botId
- `signalr-prod-portfolio` — used by leaderboard and trader profile routes
- `signalr-prod-executor-trades` — PK: botId, SK: timestamp. GSI: sub-index (PK: sub, SK: timestamp)
- `signalr-prod-market-price-history` — used by bot-perf-recorder

### API Gateway
- REST API: `signalr-prod-domain-rest-api` (ID: g201e6xu09)
- API Gateway execution logging is NOT enabled for the prod REST API

## Analytics Handler Configuration
- Timeout: **3 seconds** (potential issue as user base grows — leaderboard does full table scan + N parallel DDB queries)
- Memory: 256 MB
- Runtime: nodejs24.x
- No top-level try/catch in any domain handler (index.ts files)

### Executor Handler Configuration
- `signalr-prod-executor-handler` — serves GET /trades and GET /trades/{botId}. Timeout: 3s, Memory: 256MB
- Env vars at runtime: `TRADES_TABLE_NAME` only — `BOTS_TABLE_NAME` is NOT injected (CDK omission in `infrastructure/lib/domain-executor.ts`)
- `signalr-prod-executor-bot-executor` — correctly has both `BOTS_TABLE_NAME` and `TRADES_TABLE_NAME` injected

## Known Issues / Patterns

### 502 Investigation (2026-02-27, confirmed pattern)
- Analytics handler logs show ZERO application-level output across ALL 143 invocations over 24+ hours — no console.log, no errors
- Lambda always completes successfully (no Lambda-level error), BUT API Gateway returns 502
- Key finding: ZERO console output is expected (code has no console.log calls) — this is NOT the problem
- Sub-25ms durations (12ms, 14ms, 24ms) observed in many requests — these are likely 404 route-miss hits (default case in switch, no DDB I/O)
- Longer durations (300–718ms) are genuine DDB-touching routes
- Most recent log entry at 12:21:49 UTC — 502 reported at ~12:23 UTC (possible log ingestion lag)
- NO unhandled Lambda exception evidence anywhere — Lambda exits cleanly
- The 502 is being generated by API Gateway itself, not by a Lambda crash
- API Gateway execution logging NOT enabled — cannot see what route/response caused the 502
- Key clue: The `getBotPerformance` route calls `GetCommand` with `Key: { sub, botId }` — the bots table PK IS `sub` so that is correct
- bots table has only 1 item (early platform, small user base)
- CONFIRMED: API Gateway access logs not configured (only /aws/apigateway/welcome exists)
- See `debugging.md` for full investigation notes
- **Suspected root cause**: No top-level try/catch in `handler()` in index.ts — an unhandled promise rejection from any DDB call returns nothing to API Gateway → 502. Lambda runtime shows the invocation as complete but returns no valid proxy response body.

### GET /trades/{botId} 502 — CONFIRMED ROOT CAUSE (2026-02-27)
- Every single invocation of `signalr-prod-executor-handler` for `GET /trades/{botId}` throws a DynamoDB ValidationException: "Value null at 'tableName' failed to satisfy constraint: Member must not be null"
- The `listBotTrades` route in `/src/domains/executor/routes/list-bot-trades.ts` line 25 reads `process.env.BOTS_TABLE_NAME!` which is `undefined` at runtime → DynamoDB receives `null` as the TableName → ValidationException → unhandled exception → Lambda exits without returning a valid proxy response → API Gateway 502
- Fix: In `infrastructure/lib/domain-executor.ts`, add `BOTS_TABLE_NAME: props.botsTable.tableName` to the `handler` function's `environment` block (line ~71), and add `props.botsTable.grantReadData(handler)` after line 75

## Reserved Words Always Needing Aliases
`sub`, `status`, `name`, `timestamp`, `type`, `size`, `value`, `pair` (verify before using)
